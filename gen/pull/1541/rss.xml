<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>cpprefjp - C++日本語リファレンス</title>
  <link href="https://cpprefjp.github.io" />
  <updated>2025-12-03T02:06:48.634878</updated>
  <id>71c1a548-b061-4dd2-ab63-acaae111a361</id>

  
    <entry>
      <title>mblen -- fix(cstdlib/mblen): 内部状態と std::mbrlen を言及</title>
      <link href="https://cpprefjp.github.io/reference/cstdlib/mblen.html"/>
      <id>19e6007105abc63f99cc77fa449adfbc06bb4839:reference/cstdlib/mblen.md</id>
      <updated>2025-12-03T10:48:37+09:00</updated>
      
        <summary type="html">&lt;pre&gt;&lt;code&gt;diff --git a/reference/cstdlib/mblen.md b/reference/cstdlib/mblen.md
index 384e04c58..6e5abd47e 100644
--- a/reference/cstdlib/mblen.md
+++ b/reference/cstdlib/mblen.md
@@ -18,6 +18,10 @@ namespace std {
 
 `n`は解析に使用する最大バイト数を指定する。
 
+この関数は `std::mbstate_t` に等価な静的記憶域の内部状態を保持し、前回の `mblen` 関数呼び出しの続きとして処理を行う。
+従って、この関数はスレッドセーフではない。
+スレッドセーフに処理する場合は、`std::mbstate_t` を受け取る [`std::mbrlen`](../cwchar/mbrlen.md.nolink) (`&amp;lt;cwchar&amp;gt;`) を使い、呼び出し元でデコード状態の記録場所 `std::mbstate_t` を用意する。
+
 ## 戻り値
 - 正常に動作する場合、文字の占めるバイト数を返す。
 - `str`が`nullptr`の時、内部状態を初期化し`0`を返す。
@@ -77,8 +81,15 @@ int main() {
 }
 ```
 
+注意: この例は飽くまで `std::mblen` を用いて文字数を数える関数の例であるが、実用上は `std::mbrlen` を用いた実装にするのが安全である。
+上の関数 `count_chars_mblen` はスレッドーセーフでない他、呼び出し元でも `std::mblen` を使っている場合にその振る舞いを破壊する可能性がある。
+
 #### 出力例
 ```
 文字列: こんにちは世界
 文字数: 7
 ```
+
+## 関連項目
+
+- [`mbrlen`](../cwchar/mbrlen.md.nolink): `std::mbstate_t` を受け取るスレッドセーフなバージョン
&lt;/code&gt;&lt;/pre&gt;</summary>
      
      <author>
        <name>Koichi Murase</name>
        <email>myoga.murase@gmail.com</email>
      </author>
    </entry>
  
    <entry>
      <title>mblen -- fix(cstdlib/mblen): バッファオーバーランの修正</title>
      <link href="https://cpprefjp.github.io/reference/cstdlib/mblen.html"/>
      <id>bc2182d0a18880f72459fc285760deed0cfeb07f:reference/cstdlib/mblen.md</id>
      <updated>2025-12-03T11:01:35+09:00</updated>
      
        <summary type="html">&lt;pre&gt;&lt;code&gt;diff --git a/reference/cstdlib/mblen.md b/reference/cstdlib/mblen.md
index ad5bf5ae3..384e04c58 100644
--- a/reference/cstdlib/mblen.md
+++ b/reference/cstdlib/mblen.md
@@ -33,7 +33,7 @@ namespace std {
 int main() {
   std::setlocale(LC_ALL, &amp;#34;ja_JP.UTF-8&amp;#34;);
   const char *str = &amp;#34;こんにちは&amp;#34;;
-  int result = std::mblen(str, MB_CUR_MAX);
+  int result = std::mblen(str, std::strlen(s));
   std::cout &amp;lt;&amp;lt; result &amp;lt;&amp;lt; std::endl;
   return 0;
 }
@@ -56,8 +56,9 @@ int count_chars_mblen(const char* s) {
 
   int count = 0;
   std::size_t i = 0;
-  while (s[i] != &amp;#39;\0&amp;#39;) {
-    int len = std::mblen(&amp;amp;s[i], MB_CUR_MAX);
+  std::size_t bytes = std::strlen(s);
+  while (i &amp;lt; bytes) {
+    int len = std::mblen(&amp;amp;s[i], bytes - i);
     if (len &amp;lt; 0) {
       len = 1;
     }
&lt;/code&gt;&lt;/pre&gt;</summary>
      
      <author>
        <name>Koichi Murase</name>
        <email>myoga.murase@gmail.com</email>
      </author>
    </entry>
  
    <entry>
      <title>mblen -- fix(cstdlib/mblen): 文字数カウント例を諸々修正</title>
      <link href="https://cpprefjp.github.io/reference/cstdlib/mblen.html"/>
      <id>a4b0b474b15eb7a19d8abd27e599949bb1882240:reference/cstdlib/mblen.md</id>
      <updated>2025-12-03T10:28:57+09:00</updated>
      
        <summary type="html">&lt;pre&gt;&lt;code&gt;diff --git a/reference/cstdlib/mblen.md b/reference/cstdlib/mblen.md
index 4cdcd924d..ad5bf5ae3 100644
--- a/reference/cstdlib/mblen.md
+++ b/reference/cstdlib/mblen.md
@@ -51,8 +51,11 @@ int main() {
 #include &amp;lt;clocale&amp;gt;
 
 int count_chars_mblen(const char* s) {
+  // std::mblen 内部の std::mbstate_t を初期化する必要あり
+  std::mblen(nullptr, 0);
+
   int count = 0;
-  size_t i = 0;
+  std::size_t i = 0;
   while (s[i] != &amp;#39;\0&amp;#39;) {
     int len = std::mblen(&amp;amp;s[i], MB_CUR_MAX);
     if (len &amp;lt; 0) {
&lt;/code&gt;&lt;/pre&gt;</summary>
      
      <author>
        <name>Koichi Murase</name>
        <email>myoga.murase@gmail.com</email>
      </author>
    </entry>
  
    <entry>
      <title>mblen -- mblenのサンプルコード : ロケールを毎回設定すると重いので文字数計算の外にだした</title>
      <link href="https://cpprefjp.github.io/reference/cstdlib/mblen.html"/>
      <id>0b61755bd12efe68418cb790b84cf00cd8667ea5:reference/cstdlib/mblen.md</id>
      <updated>2025-12-03T10:11:53+09:00</updated>
      
        <summary type="html">&lt;pre&gt;&lt;code&gt;diff --git a/reference/cstdlib/mblen.md b/reference/cstdlib/mblen.md
index 838ee668b..4cdcd924d 100644
--- a/reference/cstdlib/mblen.md
+++ b/reference/cstdlib/mblen.md
@@ -51,7 +51,6 @@ int main() {
 #include &amp;lt;clocale&amp;gt;
 
 int count_chars_mblen(const char* s) {
-  std::setlocale(LC_ALL, &amp;#34;ja_JP.UTF-8&amp;#34;);
   int count = 0;
   size_t i = 0;
   while (s[i] != &amp;#39;\0&amp;#39;) {
@@ -66,6 +65,8 @@ int count_chars_mblen(const char* s) {
 }
 
 int main() {
+  std::setlocale(LC_ALL, &amp;#34;ja_JP.UTF-8&amp;#34;);
+
   const char* str = &amp;#34;こんにちは世界&amp;#34;;
   std::cout &amp;lt;&amp;lt; &amp;#34;文字列: &amp;#34; &amp;lt;&amp;lt; str &amp;lt;&amp;lt; &amp;#34;\n&amp;#34;;
   std::cout &amp;lt;&amp;lt; &amp;#34;文字数: &amp;#34; &amp;lt;&amp;lt; count_chars_mblen(str) &amp;lt;&amp;lt; &amp;#34;\n&amp;#34;;
&lt;/code&gt;&lt;/pre&gt;</summary>
      
      <author>
        <name>Akira Takahashi</name>
        <email>faithandbrave@gmail.com</email>
      </author>
    </entry>
  
    <entry>
      <title>mblen -- mblen : インデントを4から2に変更</title>
      <link href="https://cpprefjp.github.io/reference/cstdlib/mblen.html"/>
      <id>f73e9f6b98d891f84a1ba174e5243e41ed2ac897:reference/cstdlib/mblen.md</id>
      <updated>2025-12-03T10:11:02+09:00</updated>
      
        <summary type="html">&lt;pre&gt;&lt;code&gt;diff --git a/reference/cstdlib/mblen.md b/reference/cstdlib/mblen.md
index 3154cca3c..838ee668b 100644
--- a/reference/cstdlib/mblen.md
+++ b/reference/cstdlib/mblen.md
@@ -51,24 +51,24 @@ int main() {
 #include &amp;lt;clocale&amp;gt;
 
 int count_chars_mblen(const char* s) {
-    std::setlocale(LC_ALL, &amp;#34;ja_JP.UTF-8&amp;#34;);
-    int count = 0;
-    size_t i = 0;
-    while (s[i] != &amp;#39;\0&amp;#39;) {
-        int len = std::mblen(&amp;amp;s[i], MB_CUR_MAX);
-        if (len &amp;lt; 0) {
-            len = 1;
-        }
-        i += len;
-        count++;
+  std::setlocale(LC_ALL, &amp;#34;ja_JP.UTF-8&amp;#34;);
+  int count = 0;
+  size_t i = 0;
+  while (s[i] != &amp;#39;\0&amp;#39;) {
+    int len = std::mblen(&amp;amp;s[i], MB_CUR_MAX);
+    if (len &amp;lt; 0) {
+      len = 1;
     }
-    return count;
+    i += len;
+    count++;
+  }
+  return count;
 }
 
 int main() {
-    const char* str = &amp;#34;こんにちは世界&amp;#34;;
-    std::cout &amp;lt;&amp;lt; &amp;#34;文字列: &amp;#34; &amp;lt;&amp;lt; str &amp;lt;&amp;lt; &amp;#34;\n&amp;#34;;
-    std::cout &amp;lt;&amp;lt; &amp;#34;文字数: &amp;#34; &amp;lt;&amp;lt; count_chars_mblen(str) &amp;lt;&amp;lt; &amp;#34;\n&amp;#34;;
+  const char* str = &amp;#34;こんにちは世界&amp;#34;;
+  std::cout &amp;lt;&amp;lt; &amp;#34;文字列: &amp;#34; &amp;lt;&amp;lt; str &amp;lt;&amp;lt; &amp;#34;\n&amp;#34;;
+  std::cout &amp;lt;&amp;lt; &amp;#34;文字数: &amp;#34; &amp;lt;&amp;lt; count_chars_mblen(str) &amp;lt;&amp;lt; &amp;#34;\n&amp;#34;;
 }
 ```
 
&lt;/code&gt;&lt;/pre&gt;</summary>
      
      <author>
        <name>Akira Takahashi</name>
        <email>faithandbrave@gmail.com</email>
      </author>
    </entry>
  
</feed>