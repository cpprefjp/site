<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>cpprefjp - C++日本語リファレンス</title>
  <link href="https://cpprefjp.github.io" />
  <updated>2025-12-03T14:38:28.004783</updated>
  <id>3fe2cfbc-3ac8-4795-bc33-62baef48e27d</id>

  
    <entry>
      <title>mblen -- fix(cstdlib/mblen): 内部状態と std::mbrlen を言及</title>
      <link href="https://cpprefjp.github.io/reference/cstdlib/mblen.html"/>
      <id>3dc288591ad11b8e493dc7638f20c7a00424253a:reference/cstdlib/mblen.md</id>
      <updated>2025-12-03T10:48:37+09:00</updated>
      
        <summary type="html">&lt;pre&gt;&lt;code&gt;diff --git a/reference/cstdlib/mblen.md b/reference/cstdlib/mblen.md
index 4bdf01934..c38e3d3d8 100644
--- a/reference/cstdlib/mblen.md
+++ b/reference/cstdlib/mblen.md
@@ -18,6 +18,11 @@ namespace std {
 
 `n`は解析に使用する最大バイト数を指定する。
 
+この関数は `std::mbstate_t` に等価な静的記憶域の内部状態を保持し、前回の `mblen` 関数呼び出しの続きとして処理を行う。
+従って、この関数はスレッドセーフではない。
+スレッドセーフに処理する場合は、`std::mbstate_t` を受け取る [`std::mbrlen`](../cwchar/mbrlen.md.nolink) (`&amp;lt;cwchar&amp;gt;`) を使い、呼び出し元でデコード状態の記録場所 `std::mbstate_t` を用意する必要がある。
+新しいコードでは、特に理由がない限り `std::mblen` ではなく `std::mbrlen` を用いるべきである。
+
 ## 戻り値
 - 正常に動作する場合、文字の占めるバイト数を返す。
 - `str`が`nullptr`の時、内部状態を初期化する。現在のエンコーディングが状態を持つ場合は非ゼロの値を返し、それ以外の場合は`0`を返す。
@@ -79,8 +84,15 @@ int main() {
 }
 ```
 
+注意: この例は飽くまで `std::mblen` を用いて文字数を数える関数の例であるが、実用上は `std::mbrlen` を用いた実装にするのが安全である。
+上の関数 `count_chars_mblen` はスレッドーセーフでない他、呼び出し元でも `std::mblen` を使っている場合にその振る舞いを破壊する可能性がある。
+
 #### 出力例
 ```
 文字列: こんにちは世界
 文字数: 7
 ```
+
+## 関連項目
+
+- [`mbrlen`](../cwchar/mbrlen.md.nolink): `std::mbstate_t` を受け取るスレッドセーフなバージョン
&lt;/code&gt;&lt;/pre&gt;</summary>
      
      <author>
        <name>Koichi Murase</name>
        <email>myoga.murase@gmail.com</email>
      </author>
    </entry>
  
    <entry>
      <title>mblen -- fix(cstdlib/mblen): バッファオーバーランの修正</title>
      <link href="https://cpprefjp.github.io/reference/cstdlib/mblen.html"/>
      <id>4a9b8871d00120f54b5a08b1e0e7e35917b2e56f:reference/cstdlib/mblen.md</id>
      <updated>2025-12-03T11:01:35+09:00</updated>
      
        <summary type="html">&lt;pre&gt;&lt;code&gt;diff --git a/reference/cstdlib/mblen.md b/reference/cstdlib/mblen.md
index e20519737..4bdf01934 100644
--- a/reference/cstdlib/mblen.md
+++ b/reference/cstdlib/mblen.md
@@ -26,14 +26,15 @@ namespace std {
 ## 例
 ### 基本的な使い方
 ```cpp example
-#include &amp;lt;iostream&amp;gt;
-#include &amp;lt;cstdlib&amp;gt;
 #include &amp;lt;clocale&amp;gt;
+#include &amp;lt;cstdlib&amp;gt;
+#include &amp;lt;cstring&amp;gt;
+#include &amp;lt;iostream&amp;gt;
 
 int main() {
   std::setlocale(LC_ALL, &amp;#34;ja_JP.UTF-8&amp;#34;);
   const char *str = &amp;#34;こんにちは&amp;#34;;
-  int result = std::mblen(str, MB_CUR_MAX);
+  int result = std::mblen(str, std::strlen(str));
   std::cout &amp;lt;&amp;lt; result &amp;lt;&amp;lt; std::endl;
   return 0;
 }
@@ -46,9 +47,10 @@ int main() {
 
 ### 文字列の文字数を計算する
 ```cpp example
-#include &amp;lt;iostream&amp;gt;
-#include &amp;lt;cstdlib&amp;gt;
 #include &amp;lt;clocale&amp;gt;
+#include &amp;lt;cstdlib&amp;gt;
+#include &amp;lt;cstring&amp;gt;
+#include &amp;lt;iostream&amp;gt;
 
 int count_chars_mblen(const char* s) {
   // std::mblen 内部の std::mbstate_t を初期化する必要あり
@@ -56,8 +58,9 @@ int count_chars_mblen(const char* s) {
 
   int count = 0;
   std::size_t i = 0;
-  while (s[i] != &amp;#39;\0&amp;#39;) {
-    int len = std::mblen(&amp;amp;s[i], MB_CUR_MAX);
+  std::size_t bytes = std::strlen(s);
+  while (i &amp;lt; bytes) {
+    int len = std::mblen(&amp;amp;s[i], bytes - i);
     if (len &amp;lt; 0) {
       len = 1;
     }
&lt;/code&gt;&lt;/pre&gt;</summary>
      
      <author>
        <name>Koichi Murase</name>
        <email>myoga.murase@gmail.com</email>
      </author>
    </entry>
  
    <entry>
      <title>mblen -- fix(cstdlib/mblen): 諸々の修正</title>
      <link href="https://cpprefjp.github.io/reference/cstdlib/mblen.html"/>
      <id>0d0c489493c7f6a765eca712991593caa0165687:reference/cstdlib/mblen.md</id>
      <updated>2025-12-03T10:28:57+09:00</updated>
      
        <summary type="html">&lt;pre&gt;&lt;code&gt;diff --git a/reference/cstdlib/mblen.md b/reference/cstdlib/mblen.md
index 4cdcd924d..e20519737 100644
--- a/reference/cstdlib/mblen.md
+++ b/reference/cstdlib/mblen.md
@@ -14,13 +14,13 @@ namespace std {
 
 先頭以外の文字に関するバイト数は計算されない。
 
-この関数は現在のロケールに依存してマルチバイト文字を解釈する。
+この関数は現在のロケールカテゴリー `LC_CTYPE` に依存してマルチバイト文字を解釈する。
 
 `n`は解析に使用する最大バイト数を指定する。
 
 ## 戻り値
 - 正常に動作する場合、文字の占めるバイト数を返す。
-- `str`が`nullptr`の時、内部状態を初期化し`0`を返す。
+- `str`が`nullptr`の時、内部状態を初期化する。現在のエンコーディングが状態を持つ場合は非ゼロの値を返し、それ以外の場合は`0`を返す。
 - 無効な文字列、または`n`が不足している場合、`-1`を返す。
 
 ## 例
@@ -51,8 +51,11 @@ int main() {
 #include &amp;lt;clocale&amp;gt;
 
 int count_chars_mblen(const char* s) {
+  // std::mblen 内部の std::mbstate_t を初期化する必要あり
+  std::mblen(nullptr, 0);
+
   int count = 0;
-  size_t i = 0;
+  std::size_t i = 0;
   while (s[i] != &amp;#39;\0&amp;#39;) {
     int len = std::mblen(&amp;amp;s[i], MB_CUR_MAX);
     if (len &amp;lt; 0) {
&lt;/code&gt;&lt;/pre&gt;</summary>
      
      <author>
        <name>Koichi Murase</name>
        <email>myoga.murase@gmail.com</email>
      </author>
    </entry>
  
    <entry>
      <title>mblen -- mblenのサンプルコード : ロケールを毎回設定すると重いので文字数計算の外にだした</title>
      <link href="https://cpprefjp.github.io/reference/cstdlib/mblen.html"/>
      <id>0b61755bd12efe68418cb790b84cf00cd8667ea5:reference/cstdlib/mblen.md</id>
      <updated>2025-12-03T10:11:53+09:00</updated>
      
        <summary type="html">&lt;pre&gt;&lt;code&gt;diff --git a/reference/cstdlib/mblen.md b/reference/cstdlib/mblen.md
index 838ee668b..4cdcd924d 100644
--- a/reference/cstdlib/mblen.md
+++ b/reference/cstdlib/mblen.md
@@ -51,7 +51,6 @@ int main() {
 #include &amp;lt;clocale&amp;gt;
 
 int count_chars_mblen(const char* s) {
-  std::setlocale(LC_ALL, &amp;#34;ja_JP.UTF-8&amp;#34;);
   int count = 0;
   size_t i = 0;
   while (s[i] != &amp;#39;\0&amp;#39;) {
@@ -66,6 +65,8 @@ int count_chars_mblen(const char* s) {
 }
 
 int main() {
+  std::setlocale(LC_ALL, &amp;#34;ja_JP.UTF-8&amp;#34;);
+
   const char* str = &amp;#34;こんにちは世界&amp;#34;;
   std::cout &amp;lt;&amp;lt; &amp;#34;文字列: &amp;#34; &amp;lt;&amp;lt; str &amp;lt;&amp;lt; &amp;#34;\n&amp;#34;;
   std::cout &amp;lt;&amp;lt; &amp;#34;文字数: &amp;#34; &amp;lt;&amp;lt; count_chars_mblen(str) &amp;lt;&amp;lt; &amp;#34;\n&amp;#34;;
&lt;/code&gt;&lt;/pre&gt;</summary>
      
      <author>
        <name>Akira Takahashi</name>
        <email>faithandbrave@gmail.com</email>
      </author>
    </entry>
  
    <entry>
      <title>mblen -- mblen : インデントを4から2に変更</title>
      <link href="https://cpprefjp.github.io/reference/cstdlib/mblen.html"/>
      <id>f73e9f6b98d891f84a1ba174e5243e41ed2ac897:reference/cstdlib/mblen.md</id>
      <updated>2025-12-03T10:11:02+09:00</updated>
      
        <summary type="html">&lt;pre&gt;&lt;code&gt;diff --git a/reference/cstdlib/mblen.md b/reference/cstdlib/mblen.md
index 3154cca3c..838ee668b 100644
--- a/reference/cstdlib/mblen.md
+++ b/reference/cstdlib/mblen.md
@@ -51,24 +51,24 @@ int main() {
 #include &amp;lt;clocale&amp;gt;
 
 int count_chars_mblen(const char* s) {
-    std::setlocale(LC_ALL, &amp;#34;ja_JP.UTF-8&amp;#34;);
-    int count = 0;
-    size_t i = 0;
-    while (s[i] != &amp;#39;\0&amp;#39;) {
-        int len = std::mblen(&amp;amp;s[i], MB_CUR_MAX);
-        if (len &amp;lt; 0) {
-            len = 1;
-        }
-        i += len;
-        count++;
+  std::setlocale(LC_ALL, &amp;#34;ja_JP.UTF-8&amp;#34;);
+  int count = 0;
+  size_t i = 0;
+  while (s[i] != &amp;#39;\0&amp;#39;) {
+    int len = std::mblen(&amp;amp;s[i], MB_CUR_MAX);
+    if (len &amp;lt; 0) {
+      len = 1;
     }
-    return count;
+    i += len;
+    count++;
+  }
+  return count;
 }
 
 int main() {
-    const char* str = &amp;#34;こんにちは世界&amp;#34;;
-    std::cout &amp;lt;&amp;lt; &amp;#34;文字列: &amp;#34; &amp;lt;&amp;lt; str &amp;lt;&amp;lt; &amp;#34;\n&amp;#34;;
-    std::cout &amp;lt;&amp;lt; &amp;#34;文字数: &amp;#34; &amp;lt;&amp;lt; count_chars_mblen(str) &amp;lt;&amp;lt; &amp;#34;\n&amp;#34;;
+  const char* str = &amp;#34;こんにちは世界&amp;#34;;
+  std::cout &amp;lt;&amp;lt; &amp;#34;文字列: &amp;#34; &amp;lt;&amp;lt; str &amp;lt;&amp;lt; &amp;#34;\n&amp;#34;;
+  std::cout &amp;lt;&amp;lt; &amp;#34;文字数: &amp;#34; &amp;lt;&amp;lt; count_chars_mblen(str) &amp;lt;&amp;lt; &amp;#34;\n&amp;#34;;
 }
 ```
 
&lt;/code&gt;&lt;/pre&gt;</summary>
      
      <author>
        <name>Akira Takahashi</name>
        <email>faithandbrave@gmail.com</email>
      </author>
    </entry>
  
</feed>