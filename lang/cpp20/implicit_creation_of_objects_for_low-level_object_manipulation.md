# æœªåˆæœŸåŒ–é ˜åŸŸã¸ã®æš—é»™çš„ãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæ§‹ç¯‰
* cpp20[meta cpp]

## æ¦‚è¦

`new`å¼ã§ã¯ãªã`malloc()`ç­‰ä»–ã®æ–¹æ³•ã§ç¢ºä¿ã•ã‚ŒãŸãƒ¡ãƒ¢ãƒªé ˜åŸŸã«ã¯ã€æ˜ç¤ºçš„ã«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®æ§‹ç¯‰ã‚’è¡Œã†ã¾ã§æƒ³å®šã™ã‚‹å‹ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯ç”Ÿå­˜æœŸé–“å†…ã«ãªãã€ãã®ã‚¢ã‚¯ã‚»ã‚¹ï¼ˆèª­ã¿æ›¸ãï¼‰ã¯æœªå®šç¾©å‹•ä½œã¨ãªã‚‹ã€‚

```cpp
struct X {
  int a;
  int b;
};

X *make_x() {
  // malloc()ã¯ãƒ¡ãƒ¢ãƒªã®ç¢ºä¿ã ã‘ã‚’è¡Œã†
  X *p = (X*)malloc(sizeof(struct X));
  
  // pã®é ˜åŸŸã«ã¯Xã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒæ§‹ç¯‰ã•ã‚Œã¦ã„ãªã„
  p->a = 1; // ğŸ’€ UB
  p->b = 2; // ğŸ’€ UB

  return p;
}
```

ã“ã®æ§˜ãªã‚³ãƒ¼ãƒ‰ã¯ç´”ç²‹ãªC++ã§ã¯`new`å¼ã‚’ç”¨ã„ã‚‹ã“ã¨ã«ãªã‚Šã€ãã®å ´åˆã¯å•é¡Œãªã„ã€‚

```cpp
// newå¼ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆ
X *make_x() {
  // newå¼ã¯ãƒ¡ãƒ¢ãƒªã®ç¢ºä¿ã¨ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæ§‹ç¯‰ã‚’è¡Œã†
  X *p = new X;
  
  // pã®é ˜åŸŸã«ã¯Xã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒæ§‹ç¯‰æ¸ˆ
  p->a = 1; // âœ… ok
  p->b = 2; // âœ… ok

  return p;
}
```

ä¸€ç•ªæœ€åˆã®`malloc()`ã‚’ç”¨ã„ã‚‹ã‚³ãƒ¼ãƒ‰ã¯ä¸»ã«Cã®ã‚³ãƒ¼ãƒ‰ã¨å…±æœ‰ã™ã‚‹éƒ¨åˆ†ã§ç¾ã‚Œã‚‹ã“ã¨ãŒã‚ã‚Šã€Cã§ã¯å•é¡Œãªã„ã‚‚ã®ã®C++ã‚³ãƒ¼ãƒ‰ã¨ã—ã¦ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã—ãŸå ´åˆã«ã®ã¿æœªå®šç¾©å‹•ä½œã¨ãªã‚‹ã€‚C++20ã‹ã‚‰ã¯ã€ã“ã®æ§˜ãªã‚³ãƒ¼ãƒ‰ã®C/C++ç›¸äº’é‹ç”¨æ€§å‘ä¸Šã®ãŸã‚ã«ã€æ˜ç¤ºçš„ã«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ§‹ç¯‰ã™ã‚‹å¿…è¦ãŒãªã„ã¨ã¿ãªã™ã“ã¨ã®ã§ãã‚‹ä¸€éƒ¨ã®å‹ï¼ˆ*implicit-lifetime types*ï¼‰ã«é™ã£ã¦ã€æœªåˆæœŸåŒ–é ˜åŸŸã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã«æš—é»™çš„ã«ï¼ˆè‡ªå‹•çš„ã«ï¼‰ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒæ§‹ç¯‰ã•ã‚Œã‚‹æ§˜ã«ãªã‚Šã€æœªå®šç¾©å‹•ä½œã‚’å›é¿ã§ãã‚‹æ§˜ã«ãªã‚‹ã€‚

## å•é¡Œã¨ãªã‚‹ä»–ã®ä¾‹

ä»¥ä¸‹ã®ä¾‹ã¯ã“ã®å¤‰æ›´ã«ã‚ˆã£ã¦è§£æ±ºã•ã‚Œã‚‹ä¾‹ã§ã‚ã‚Šã€C++17ä»¥å‰ã¯æœªå®šç¾©å‹•ä½œã¨ãªã‚‹ã‚‚ã®ã§ã‚ã‚‹ã€‚

### `operator new`

`new`å¼ã§ã¯ãªã`operator new()`ã‚’ç›´æ¥ä½¿ç”¨ã™ã‚‹å ´åˆã¯åŒæ§˜ã®å•é¡ŒãŒã‚ã‚‹ã€‚

```cpp
// newæ¼”ç®—å­ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆ
X *make_x() {
  // operator new()ã¯ãƒ¡ãƒ¢ãƒªã®ç¢ºä¿ã ã‘ã‚’è¡Œã†
  X *p = (X*)::operator new(sizeof(struct X));
  
  // pã®é ˜åŸŸã«ã¯Xã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒæ§‹ç¯‰ã•ã‚Œã¦ã„ãªã„
  p->a = 1; // ğŸ’€ UB
  p->b = 2; // ğŸ’€ UB

  return p;
}
```

### å…±ç”¨ä½“ã®ã‚³ãƒ”ãƒ¼

```cpp
union U {
  int n;
  float f;
};

float pun(int n) {
  // U::nã®ç”Ÿå­˜æœŸé–“ãŒé–‹å§‹
  U u = {.n = n};
  
  // ã“ã®ã‚³ãƒ”ãƒ¼ã§ã¯uã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆè¡¨ç¾ãŒã‚³ãƒ”ãƒ¼ã•ã‚Œã‚‹ã‚‚ã®ã®ã€ãƒ¡ãƒ³ãƒã®ç”Ÿå­˜æœŸé–“ã¯é–‹å§‹ã•ã‚Œãªã„
  // ãã®ãŸã‚ã€ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¡ãƒ³ãƒãŒç„¡ã„çŠ¶æ…‹ã¨ãªã‚‹
  U u2 = u;
  
  // u2.fã¯éã‚¢ã‚¯ãƒ†ã‚£ãƒ–
  return u2.f; // ğŸ’€ UB
}
```

### ãƒã‚¤ãƒˆé…åˆ—ã®èª­ã¿è¾¼ã¿

```cpp
// ä½•ã‹ãƒã‚¤ãƒˆåˆ—ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’å—ã‘å–ã£ã¦å‡¦ç†ã™ã‚‹é–¢æ•°ã¨ã™ã‚‹
void process(Stream *stream) {
  // ãƒã‚¤ãƒˆé…åˆ—ã®èª­ã¿å‡ºã—
  std::unique_ptr<char[]> buffer = stream->read();

  // å…ˆé ­ãƒã‚¤ãƒˆã®çŠ¶æ…‹ã«ã‚ˆã£ã¦åˆ†å²
  if (buffer[0] == FOO) {
    process_foo(reinterpret_cast<Foo*>(buffer.get())); // #1
  } else {
    process_bar(reinterpret_cast<Bar*>(buffer.get())); // #2
  }
}
```

1ã¤ã®é ˜åŸŸã«è¤‡æ•°ã®å‹ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒåŒæ™‚ã«ç”Ÿå­˜æœŸé–“å†…ã«ã‚ã‚‹ã“ã¨ã¯ãªã„ãŸã‚ã€`stream->read()`ãŒå†…éƒ¨ã§`Foo, Bar`ã©ã¡ã‚‰ã‹ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ§‹ç¯‰ã—ã¦ã„ãŸã¨ã—ã¦ã‚‚ã€`#1`ã¨`#2`ã®ã©ã¡ã‚‰ã‹ã®ãƒ‘ã‚¹ã¯æœªå®šç¾©å‹•ä½œã¨ãªã‚‹ã€‚ãã—ã¦ã€ã“ã®æ§˜ãªã‚³ãƒ¼ãƒ‰ã§ã¯å¤šãã®å ´åˆã€æ˜ç¤ºçš„ã«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒæ§‹ç¯‰ã•ã‚Œã‚‹ã“ã¨ã¯ãªã„ã€‚

### å‹•çš„é…åˆ—ã®å®Ÿè£…

```cpp
// std::vectorã®æ§˜ãªå‹•çš„é…åˆ—å‹ã‚’å®Ÿè£…ã—ãŸã„
template<typename T>
struct Vec {
  char *buf = nullptr;
  char *buf_end_size = nullptr;
  char *buf_end_capacity = nullptr;

  void reserve(std::size_t n) {
    char *newbuf = (char*)::operator new(n * sizeof(T), std::align_val_t(alignof(T)));
    std::uninitialized_copy(begin(), end(), (T*)newbuf); // #a ğŸ’€ UB

    ::operator delete(buf, std::align_val_t(alignof(T)));
    buf = newbuf;
    buf_end_size = newbuf + sizeof(T) * size(); // #b ğŸ’€ UB
    buf_end_capacity = newbuf + sizeof(T) * n;  // #c ğŸ’€ UB
  }

  void push_back(T t) {
    if (buf_end_size == buf_end_capacity)
      reserve(std::max<std::size_t>(size() * 2, 1));
    new (buf_end_size) T(t);
    buf_end_size += sizeof(T); // #d ğŸ’€ UB
  }

  T *begin() { return (T*)buf; }

  T *end() { return (T*)buf_end_size; }

  std::size_t size() { return end() - begin(); } // #e ğŸ’€ UB
};

int main() {
  Vec<int> v;
  v.push_back(1);
  v.push_back(2);
  v.push_back(3);
  for (int n : v) { /*...*/ } // #f ğŸ’€ UB
}
```

C++ã«ãŠã„ã¦ã¯ã€ãƒã‚¤ãƒ³ã‚¿ã«å¯¾ã™ã‚‹æ¼”ç®—ï¼ˆ`+ -`ãªã©ï¼‰ã¯ãã®ãƒã‚¤ãƒ³ã‚¿ãŒé…åˆ—ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æŒ‡ã—ã¦ã„ã‚‹å ´åˆã«ã®ã¿æœ‰åŠ¹ã¨ãªã‚‹ãŒã€ä¾‹ä¸­ã®`#a #b #c #d #e #f`ã§ä½¿ç”¨ã•ã‚Œã‚‹ãƒã‚¤ãƒ³ã‚¿ã®æŒ‡ã™é ˜åŸŸã«ã¯ã„ãšã‚Œã‚‚é…åˆ—ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒç”Ÿå­˜æœŸé–“ã«ãªã„ï¼ˆæ­£ç¢ºã«ã¯ã€éé…åˆ—ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒã‚¤ãƒ³ã‚¿ã®å ´åˆã¯è¦ç´ æ•°1ã®é…åˆ—ã¨ã—ã¦æ‰±ã‚ã‚Œã‚‹ãŒã€ã“ã®ä¾‹ã®å ´åˆã¯ãã‚Œã‚’æº€ãŸã™ã“ã¨ã¯ã»ã¼ãªãã€æº€ãŸã•ãªã„ã‚‚ã®ã¨ã™ã‚‹ï¼‰ã€‚ãã®ãŸã‚ã€ãã®ãƒã‚¤ãƒ³ã‚¿ã‚’ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚¿ã®æ§˜ã«ä½¿ç”¨ã™ã‚‹ã“ã¨ã¯æœªå®šç¾©å‹•ä½œã¨ãªã‚‹ã€‚

## ä»•æ§˜

### implicit-lifetime types

æ˜ç¤ºçš„ã«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ§‹ç¯‰ã™ã‚‹å¿…è¦ãŒãªã„ã¨ã¿ãªã™ã“ã¨ã®ã§ãã‚‹ä¸€éƒ¨ã®å‹ã¯*implicit-lifetime types*ã¨å‘¼ã°ã‚Œã‚‹æ¬¡ã®ã„ãšã‚Œã‹ã«è©²å½“ã™ã‚‹å‹ã§ã‚ã‚‹

1. [ã‚¹ã‚«ãƒ©å‹](/reference/type_traits/is_scalar.md)
2. é…åˆ—å‹
    - è¦ç´ å‹ã¯å•ã‚ãªã„
3. *implicit-lifetime class types*
    - ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ãŒãƒ¦ãƒ¼ã‚¶ãƒ¼å®šç¾©ã•ã‚Œã¦ã„ãªã„é›†æˆä½“å‹ã€ã‚‚ã—ãã¯
    - å°‘ãªãã¨ã‚‚1ã¤ã®è³‡æ ¼ã®ã‚ã‚‹ãƒˆãƒªãƒ“ã‚¢ãƒ«ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã¨ã€ãƒˆãƒªãƒ“ã‚¢ãƒ«ã§å‰Šé™¤ã•ã‚Œã¦ã„ãªã„ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã‚’æŒã¤å‹
4. 1~3ã®CVä¿®é£¾ã•ã‚ŒãŸå‹

### ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æš—é»™çš„ã«æ§‹ç¯‰ã™ã‚‹æ“ä½œ

æ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªä¸­ã®æ¬¡ã®é–¢æ•°ã¯ã€*implicit-lifetime types*ã«å¯¾ã—ã¦ä½¿ç”¨ã—ãŸå ´åˆã«ã€ãã®æŒ¯ã‚‹èˆã„ã®ä¸€ç’°ã¨ã—ã¦æŒ‡å®šã•ã‚ŒãŸé ˜åŸŸå†…ã«ãã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æš—é»™çš„ã«æ§‹ç¯‰ã™ã‚‹

- `new`æ¼”ç®—å­
    - `opreator new`
    - `opreator new[]`
- ã‚¢ãƒ­ã‚±ãƒ¼ã‚¿
    - [`std::allocator<T>::allocate`](/reference/memory/allocator/allocate.md)
- Cãƒ©ã‚¤ãƒ–ãƒ©ãƒªé–¢æ•°
    - `std::aligned_alloc`
    - `std::calloc`
    - `std::malloc`
    - `std::realloc`
    - `std::memcpy`
    - `std::memmove`
- [`std::bit_cast`](/reference/bit/bit_cast.md)

ã“ã‚Œã‚‰ã®æ“ä½œã¯ãã‚Œãã‚Œã€æ¬¡ã®ã‚ˆã†ã«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æš—é»™çš„ã«æ§‹ç¯‰ã™ã‚‹

- `new`æ¼”ç®—å­ã¨Cã®ãƒ¡ãƒ¢ãƒªç¢ºä¿é–¢æ•°
    - è¿”ã•ã‚ŒãŸé ˜åŸŸã«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ§‹ç¯‰ã—ã€æ§‹ç¯‰ã•ã‚ŒãŸé©åˆ‡ãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¸ã®ãƒã‚¤ãƒ³ã‚¿ã‚’è¿”ã™
        - `calloc/realloc`ã®å ´åˆã€æš—é»™çš„ãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæ§‹ç¯‰ã¯ã‚¼ãƒ­åŸ‹ã‚/ã‚³ãƒ”ãƒ¼ãŒè¡Œã‚ã‚Œã‚‹å‰ã«è¡Œã‚ã‚Œã‚‹
- [`std::allocator::allocate`](/reference/memory/allocator/allocate.md)
    - è¿”ã•ã‚ŒãŸé…åˆ—å‹ã®é ˜åŸŸã«ãã®é…åˆ—å‹ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ§‹ç¯‰ã™ã‚‹ãŒã€é…åˆ—è¦ç´ ã¯æ§‹ç¯‰ã•ã‚Œãªã„
- `std::memcpy/std::memmove`
    - ã‚³ãƒ”ãƒ¼å…ˆé ˜åŸŸã¸ã®æš—é»™çš„ãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæ§‹ç¯‰ã¯ã€ã‚³ãƒ”ãƒ¼å…ˆé ˜åŸŸã«ã‚³ãƒ”ãƒ¼ã‚’ã™ã‚‹å‰ã«è¡Œã‚ã‚Œã‚‹
- [`std::bit_cast`](/reference/bit/bit_cast.md)
    - ãƒã‚¹ãƒˆã—ãŸã‚‚ã®ã‚‚å«ã‚ã¦ã€çµæœé ˜åŸŸã«æš—é»™ã«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ§‹ç¯‰ã™ã‚‹
        - ãƒã‚¹ãƒˆã—ãŸã‚‚ã®ã€ã¨ã¯ä¾‹ãˆã°ã‚¯ãƒ©ã‚¹ãƒ¡ãƒ³ãƒã‚„é…åˆ—ã®è¦ç´ ã®ã“ã¨

ã¾ãŸã€ã“ã‚Œã‚‰ã®æ“ä½œã«é™ã‚‰ãšã€`char, unsigned char, std::byte`ã®é…åˆ—ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ§‹ç¯‰ã—ãã®ç”Ÿå­˜æœŸé–“ã‚’é–‹å§‹ã™ã‚‹æ“ä½œã¯ã€ãã®é…åˆ—ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒå æœ‰ã™ã‚‹é ˜åŸŸå†…ã«ãã®è¦ç´ ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æš—é»™çš„ã«æ§‹ç¯‰ã™ã‚‹ã€‚

#### å…±ç”¨ä½“ã®ã‚³ãƒ”ãƒ¼æ“ä½œ

å…±ç”¨ä½“ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚³ãƒ”ãƒ¼/ãƒ ãƒ¼ãƒ–ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã¨ä»£å…¥æ¼”ç®—å­ã§ã¯ã€æ¬¡ã®ã‚ˆã†ã«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æš—é»™çš„ã«æ§‹ç¯‰ã™ã‚‹

- ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿
    - ã‚³ãƒ”ãƒ¼å…ƒã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ãƒã‚¹ãƒˆã—ãŸå„ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¯¾ã—ã¦ã€ã‚³ãƒ”ãƒ¼å…ˆå†…ã§å¯¾å¿œã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ`o`ã‚’
        - ã‚µãƒ–ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆ : ç‰¹å®šã™ã‚‹
        - ãã‚Œä»¥å¤–ã®å ´åˆ : æš—é»™çš„ã«æ§‹ç¯‰ã™ã‚‹
            - åˆ¥ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’æä¾›ã—ã¦ã„ã‚‹å ´åˆã‚„ã‚µãƒ–ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã‚µãƒ–ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãªã©
    - `o`ã®ç”Ÿå­˜æœŸé–“ã¯ã‚³ãƒ”ãƒ¼ã®å‰ã«é–‹å§‹ã•ã‚Œã‚‹
- ä»£å…¥æ¼”ç®—å­
  - ä»£å…¥å…ƒã¨ä»£å…¥å…ˆãŒåŒã˜ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ãªã„å ´åˆ
  - ã‚³ãƒ”ãƒ¼å…ƒã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ãƒã‚¹ãƒˆã—ãŸå„ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¯¾ã—ã¦ã€ã‚³ãƒ”ãƒ¼å…ˆå†…ã§å¯¾å¿œã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ`o`ãŒæš—é»™çš„ã«æ§‹ç¯‰ã•ã‚Œ
  - `o`ã®ç”Ÿå­˜æœŸé–“ã¯ã‚³ãƒ”ãƒ¼ã®å‰ã«é–‹å§‹ã•ã‚Œã‚‹

ã©ã¡ã‚‰ã®å ´åˆã‚‚ã€ã‚³ãƒ”ãƒ¼å…ƒã§ç”Ÿå­˜æœŸé–“å†…ã«ã‚ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒã‚³ãƒ”ãƒ¼å…ˆã§ï¼ˆå¯èƒ½ãªã‚‰ï¼‰æš—é»™çš„ã«æ§‹ç¯‰ã•ã‚Œã‚‹ã€‚

ã‚¯ãƒ©ã‚¹å‹ã‚’ãƒ¡ãƒ³ãƒã¨ã—ã¦ä¿æŒã™ã‚‹å ´åˆãªã©ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿/ä»£å…¥æ¼”ç®—å­ãŒ`delete`ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã“ã‚Œã¯è¡Œã‚ã‚Œãªã„ã€‚

### æš—é»™çš„ãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæ§‹ç¯‰

ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æš—é»™çš„ã«æ§‹ç¯‰ã™ã‚‹æ“ä½œã§ã¯ã€ãã†ã™ã‚‹ã“ã¨ã§ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒå®šç¾©ã•ã‚ŒãŸæŒ¯ã‚‹èˆã„ã‚’ã™ã‚‹ã‚ˆã†ã«ãªã‚‹ï¼ˆã™ãªã‚ã¡ã€æœªå®šç¾©å‹•ä½œãŒå›é¿ã§ãã‚‹ï¼‰å ´åˆã«ã€*implicit-lifetime types*ã®0å€‹ä»¥ä¸Šã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æš—é»™çš„ã«æ§‹ç¯‰ã—ãã®ç”Ÿå­˜æœŸé–“ã‚’é–‹å§‹ã•ã›ã‚‹ã€‚ãã®ã‚ˆã†ãªã€æš—é»™çš„ãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæ§‹ç¯‰ã«ã‚ˆã£ã¦ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã«å®šç¾©ã•ã‚ŒãŸæŒ¯ã‚‹èˆã„ã‚’ã‚‚ãŸã‚‰ã™ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®é›†åˆãŒ1ã¤ã‚‚å­˜åœ¨ã—ãªã„å ´åˆã¯æœªå®šç¾©å‹•ä½œã¨ãªã‚‹ï¼ˆã“ã‚Œã¯ä»Šã¾ã§é€šã‚Šï¼‰ã€‚é€†ã«ã€ãã®ã‚ˆã†ãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®é›†åˆãŒè¤‡æ•°å­˜åœ¨ã—ã¦ã„ã‚‹å ´åˆã¯ã€ã©ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒæš—é»™çš„ã«æ§‹ç¯‰ã•ã‚Œã‚‹ã‹ã¯æœªè¦å®šï¼ˆã“ã‚Œã¯ã€éƒ½åº¦é©åˆ‡ãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒé¸æŠã•ã‚Œæ§‹ç¯‰ã•ã‚Œã‚‹ã“ã¨ã‚’æ„å›³ã—ã¦ã„ã‚‹ï¼‰ã€‚

æš—é»™çš„ãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæ§‹ç¯‰ãŒè¡Œã‚ã‚Œã‚‹å ´åˆã€ãã®ã‚µãƒ–ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®*implicit-lifetime types*ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚‚æš—é»™çš„ã«æ§‹ç¯‰ã•ã‚Œç”Ÿå­˜æœŸé–“ãŒé–‹å§‹ã•ã‚Œã‚‹ãŒã€*implicit-lifetime types*ã§ã¯ãªã„ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯æš—é»™çš„ã«æ§‹ç¯‰ã•ã‚Œãªã„ãŸã‚æ˜ç¤ºçš„ãªåˆæœŸåŒ–ãŒå¿…è¦ã¨ãªã‚‹ã€‚

æš—é»™çš„ãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæ§‹ç¯‰ã‚’è¡Œã‚ãªãã¦ã‚‚ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒå®šç¾©ã•ã‚ŒãŸæŒ¯ã‚‹èˆã„ã‚’ã™ã‚‹ï¼ˆæœªå®šç¾©å‹•ä½œã¨ãªã‚‰ãªã„ï¼‰å ´åˆã€å¯¾è±¡ã®æ“ä½œã¯æš—é»™çš„ã«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ§‹ç¯‰ã›ãšã€é€šå¸¸ã®åŠ¹æœã®ã¿ã‚’ã‚‚ãŸã‚‰ã™ã€‚

ã•ã‚‰ã«ã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æš—é»™çš„ã«æ§‹ç¯‰ã™ã‚‹æ“ä½œã®å†…ãƒ¡ãƒ¢ãƒªã‚’ç¢ºä¿ã™ã‚‹é–¢æ•°ç­‰ä¸€éƒ¨ã®æ“ä½œã§ã¯ã€æš—é»™çš„ãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæ§‹ç¯‰ã«ã‚ˆã£ã¦ä½œæˆã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æŒ‡ã™é©åˆ‡ãªãƒã‚¤ãƒ³ã‚¿ã‚’è¿”ã™ã“ã¨ãŒè¦å®šã•ã‚Œã‚‹ã€‚ã“ã‚Œã‚‰ã®æ“ä½œã«ãŠã„ã¦ã¯ã€ãã®ãƒã‚¤ãƒ³ã‚¿å€¤ã‚’è¿”ã™ã“ã¨ã§ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒå®šç¾©ã•ã‚ŒãŸæŒ¯ã‚‹èˆã„ã‚’ã™ã‚‹ã‚ˆã†ã«ãªã‚‹å ´åˆã«ã€æŒ‡å®šã•ã‚ŒãŸé ˜åŸŸã®å…ˆé ­ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ã™ã‚‹æš—é»™çš„ã«æ§‹ç¯‰ã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®1ã¤ã‚’é¸æŠã—ã€ãã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æŒ‡ã™ãƒã‚¤ãƒ³ã‚¿å€¤ã‚’ç”Ÿæˆã—ãã‚Œã‚’è¿”ã™ã€‚ãã®ã‚ˆã†ãªã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã«å®šç¾©ã•ã‚ŒãŸæŒ¯ã‚‹èˆã„ã‚’ã‚‚ãŸã‚‰ã™ã‚ˆã†ãªãƒã‚¤ãƒ³ã‚¿å€¤ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯æœªå®šç¾©å‹•ä½œã¨ãªã‚‹ã€‚é€†ã«ã€ãã®ã‚ˆã†ãªãƒã‚¤ãƒ³ã‚¿å€¤ãŒè¤‡æ•°å­˜åœ¨ã—ã¦ã„ã‚‹å ´åˆã¯ã€ã©ã®ãƒã‚¤ãƒ³ã‚¿å€¤ãŒç”Ÿæˆã•ã‚Œã‚‹ã‹ã¯æœªè¦å®šã€‚

ãã®ã‚ˆã†ãªãƒã‚¤ãƒ³ã‚¿ç”Ÿæˆã‚’è¡Œã‚ãªãã¦ã‚‚ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒå®šç¾©ã•ã‚ŒãŸæŒ¯ã‚‹èˆã„ã‚’ã™ã‚‹å ´åˆã€ãã®ã‚ˆã†ãªãƒã‚¤ãƒ³ã‚¿å€¤ã¯ç”Ÿæˆã•ã‚Œãšã€å¯¾è±¡ã®æ“ä½œã¯é€šå¸¸ã®ãƒã‚¤ãƒ³ã‚¿å€¤ã‚’è¿”ã™ã€‚

### æ“¬ä¼¼ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ã‚¿å‘¼ã³å‡ºã—ã«ã‚ˆã‚‹ç”Ÿå­˜æœŸé–“ã®çµ‚äº†

ä¸€éƒ¨ã®æ–‡è„ˆã§ã¯ã€ã‚¹ã‚«ãƒ©å‹ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¯¾ã—ã¦ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ã‚¿å‘¼ã³å‡ºã—ã‚’è¡Œã†ã“ã¨ãŒã§ãã€ãã®å ´åˆã®ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ã‚¿å‘¼ã³å‡ºã—ã®ã“ã¨ã‚’æ“¬ä¼¼ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ã‚¿å‘¼ã³å‡ºã—ï¼ˆ*pseudo-destructor call*ï¼‰ã¨å‘¼ã¶ã€‚

C++17ã¾ã§ã€æ“¬ä¼¼ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ã‚¿å‘¼ã³å‡ºã—ã«ã¯ä½•ã®åŠ¹æœã‚‚ãªã‹ã£ãŸï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®æ–‡è„ˆã§ã‚¯ãƒ©ã‚¹å‹ã¨ã®æ§‹æ–‡ä¸Šã®äº’æ›æ€§ã‚’å–ã‚‹ãŸã‚ã®ã‚‚ã®ã§ã—ã‹ãªã‹ã£ãŸï¼‰ãŒã€C++20ã‹ã‚‰ã¯æ“¬ä¼¼ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ã‚¿å‘¼ã³å‡ºã—ã¯ãã®ã‚¹ã‚«ãƒ©å‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ç”Ÿå­˜æœŸé–“ã‚’çµ‚äº†ã•ã›ã‚‹ã“ã¨ãŒè¦å®šã•ã‚Œã‚‹ã€‚

```cpp
constexpr int f() {
  int a = 123;
  using T = int;

  // æ“¬ä¼¼ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ã‚¿å‘¼ã³å‡ºã—
  // C++20ã‹ã‚‰ã¯aã®ç”Ÿå­˜æœŸé–“ã‚’çµ‚äº†ã•ã›ã‚‹
  // C++17ã¾ã§ã¯ä½•ã‚‚åŠ¹æœãŒãªã„
  a.~T();

  return a;  // C++20ã‹ã‚‰ã¯UBã€C++17ã¾ã§ã¯123ã‚’è¿”ã™
}

static_assert(f() == 123);  // C++20ã‹ã‚‰ã¯UBãŒèµ·ã“ã‚‹ãŸã‚ä¸é©æ ¼ã€C++17ä»¥å‰ã¯é©æ ¼
```

ã“ã‚Œã«ä¼´ã„ã€[`destroy_at()`](/reference/memory/destroy_at.md)ãªã©ã®æ“¬ä¼¼ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ã‚¿å‘¼ã³å‡ºã—ã¨ç­‰ä¾¡ã®ã“ã¨ã‚’è¡Œã†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªæ©Ÿèƒ½ã«ãŠã„ã¦ã‚‚ã€ã‚¹ã‚«ãƒ©å‹ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ç”Ÿå­˜æœŸé–“ã‚’çµ‚äº†ã•ã›ã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚

### ã“ã‚Œã‚‰ã®å¤‰æ›´ã®å½±éŸ¿

ã“ã‚Œã‚‰ã®å¤‰æ›´ã¯ã‚ãã¾ã§ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆç”Ÿå­˜æœŸé–“ã«é–¢ã™ã‚‹è¦å‰‡ã‚’å¤‰æ›´ã—ãŸã ã‘ã«éããšã€ãã®å½±éŸ¿ã¯ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ç­‰ã®å®Ÿè£…ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆç”Ÿå­˜æœŸé–“ã®èªè­˜ãŒå¤‰ã‚ã‚‹ã ã‘ã§ã‚ã‚‹ã€‚ãã‚Œã«ã‚ˆã£ã¦ã€ä»Šã¾ã§æœªå®šç¾©å‹•ä½œã¨ãªã£ã¦ã„ãŸã‚³ãƒ¼ãƒ‰ãŒæœªå®šç¾©å‹•ä½œã§ã¯ãªããªã‚Šã€æœªå®šç¾©å‹•ä½œã‚’ãƒˆãƒªã‚¬ãƒ¼ã¨ã™ã‚‹æœ€é©åŒ–ã‚’å—ã‘ã‚‹å¯èƒ½æ€§ãŒå°†æ¥ã«ã‚ãŸã£ã¦å–ã‚Šé™¤ã‹ã‚Œã‚‹ã“ã¨ã«ãªã‚‹ï¼ˆãŸã ã—ã€æ“¬ä¼¼ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ã‚¿å‘¼ã³å‡ºã—å‘¨ã‚Šã®å¤‰æ›´ã ã‘ã¯ã€æœªå®šç¾©å‹•ä½œã§ã¯ãªã‹ã£ãŸã‚³ãƒ¼ãƒ‰ã‚’æœªå®šç¾©å‹•ä½œã«ã—ã†ã‚‹ï¼‰ã€‚

ã—ãŸãŒã£ã¦ã€ã“ã‚Œã‚‰ã®å¤‰æ›´ã«ã‚ˆã£ã¦å®Ÿè¡Œæ™‚ã«ä½•ã‹ã™ã¹ãã“ã¨ãŒå¢—ãˆã‚‹ã‚ã‘ã§ã¯ãªãã€æš—é»™çš„ãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæ§‹ç¯‰ã¯å®Ÿéš›ã«ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã‚’å‘¼ã‚“ã ã‚Šä½•ã‹åˆæœŸåŒ–ã‚’è¡Œã†ã‚‚ã®ã§ã¯ãªã„ã—ã€æ“¬ä¼¼ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ã‚¿å‘¼ã³å‡ºã—ãŒå®Ÿè¡Œæ™‚ã«ä½•ã‹ã‚’ã™ã‚‹ã‚ˆã†ã«ãªã‚‹ã‚ã‘ã§ã‚‚ãªã„ã€‚

## ä»¥å‰ã®å•é¡Œã®ä¿®æ­£ä¾‹

### `malloc()`/ `operator new`

```cpp
// Xã¯implicit-lifetime class types
struct X {
  int a;
  int b;
};

X *make_x() {
  // å¾Œç¶šã®Xã®ãƒ¡ãƒ³ãƒã‚¢ã‚¯ã‚»ã‚¹ã‚’å®šç¾©ã•ã‚ŒãŸæŒ¯ã‚‹èˆã„ã¨ã™ã‚‹ãŸã‚ã«
  // malloc()ã¯ãƒ¡ãƒ¢ãƒªã®ç¢ºä¿ã¨ã¨ã‚‚ã«Xã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆã¨ãƒ¡ãƒ³ãƒã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼‰ã‚’æš—é»™çš„ã«æ§‹ç¯‰ã™ã‚‹
  // ãã—ã¦ã€æ§‹ç¯‰ã•ã‚ŒãŸXã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¸ã®é©åˆ‡ãªãƒã‚¤ãƒ³ã‚¿ã‚’è¿”ã™
  X *p = (X*)malloc(sizeof(struct X));
  
  // pã®é ˜åŸŸã«ã¯Xã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒæš—é»™çš„ã«æ§‹ç¯‰ã•ã‚Œã¦ã„ã‚‹
  p->a = 1; // âœ… ok
  p->b = 2; // âœ… ok

  return p;
}
```

```cpp
// newæ¼”ç®—å­ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆ
X *make_x() {
  // å¾Œç¶šã®Xã®ãƒ¡ãƒ³ãƒã‚¢ã‚¯ã‚»ã‚¹ã‚’å®šç¾©ã•ã‚ŒãŸæŒ¯ã‚‹èˆã„ã¨ã™ã‚‹ãŸã‚ã«
  // operator new()ã¯ãƒ¡ãƒ¢ãƒªã®ç¢ºä¿ã¨ã¨ã‚‚ã«Xã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆã¨ãƒ¡ãƒ³ãƒã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼‰ã‚’æš—é»™çš„ã«æ§‹ç¯‰ã™ã‚‹
  // ãã—ã¦ã€æ§‹ç¯‰ã•ã‚ŒãŸXã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¸ã®é©åˆ‡ãªãƒã‚¤ãƒ³ã‚¿ã‚’è¿”ã™
  X *p = (X*)::operator new(sizeof(struct X));
  
  // pã®é ˜åŸŸã«ã¯Xã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒæš—é»™çš„ã«æ§‹ç¯‰ã•ã‚Œã¦ã„ã‚‹
  p->a = 1; // âœ… ok
  p->b = 2; // âœ… ok

  return p;
}
```

### å…±ç”¨ä½“ã®ã‚³ãƒ”ãƒ¼

```cpp
union U {
  int n;
  float f;
};

float pun(int n) {
  // U::nã®ç”Ÿå­˜æœŸé–“ãŒé–‹å§‹
  U u = {.n = n};
  
  // ã“ã®ã‚³ãƒ”ãƒ¼ã§ã¯uã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆè¡¨ç¾ãŒã‚³ãƒ”ãƒ¼ã•ã‚Œã‚‹ã¨ã¨ã‚‚ã«
  // uã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¡ãƒ³ãƒã«å¯¾å¿œã™ã‚‹ãƒ¡ãƒ³ãƒãŒã‚³ãƒ”ãƒ¼å…ˆã§ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã¨ãªã‚‹
  U u2 = u;
  
  // u2.fã¯éã‚¢ã‚¯ãƒ†ã‚£ãƒ–
  return u2.f; // ğŸ’€ UB
}
```

å…±ç”¨ä½“ã®ã‚³ãƒ”ãƒ¼ã«ãŠã„ã¦ã¯ã‚ãã¾ã§ã‚³ãƒ”ãƒ¼å…ƒã§ç”Ÿå­˜æœŸé–“å†…ã«ã‚ã£ãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¯¾å¿œã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒã‚³ãƒ”ãƒ¼å…ˆã§ã‚‚ç”Ÿå­˜æœŸé–“å†…ã«ã‚ã‚‹ã“ã¨ãŒä¿è¨¼ã•ã‚Œã‚‹ã ã‘ã§ã€*type-punning*ã®ã‚ˆã†ãªã“ã¨ã‚’å¯èƒ½ã«ã™ã‚‹ã‚ã‘ã§ã¯ãªã„ã€‚

```cpp
int f(int n) {
  U u = {.n = n};

  U u2 = u;
  
  // ã“ã‚Œãªã‚‰ok
  return u2.n; // âœ… ok
}
```

### ãƒã‚¤ãƒˆé…åˆ—ã®èª­ã¿è¾¼ã¿

```cpp
// ä½•ã‹ãƒã‚¤ãƒˆåˆ—ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’å—ã‘å–ã£ã¦å‡¦ç†ã™ã‚‹é–¢æ•°ã¨ã™ã‚‹
void process(Stream *stream) {
  // ãƒã‚¤ãƒˆé…åˆ—ã®èª­ã¿å‡ºã—
  std::unique_ptr<char[]> buffer = stream->read();

  // å…ˆé ­ãƒã‚¤ãƒˆã®çŠ¶æ…‹ã«ã‚ˆã£ã¦åˆ†å²
  if (buffer[0] == FOO) {
    process_foo(reinterpret_cast<Foo*>(buffer.get())); // #1
  } else {
    process_bar(reinterpret_cast<Bar*>(buffer.get())); // #2
  }
}
```

`Foo`ã‚‚`Bar`ã‚‚*implicit-lifetime types*ã ã¨ã—ã¦ã€ä»¥å‰ã®ã“ã®ã‚³ãƒ¼ãƒ‰ã«å¯¾ã—ã¦`Stream::read()`ãŒæ¬¡ã®ã‚ˆã†ã«å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹å ´åˆ

```cpp
unique_ptr<char[]> Stream::read() {
  // ... determine data size ...
  unique_ptr<char[]> buffer(new char[N]);
  // ... copy data into buffer ...
  return buffer;
}
```

ã“ã®`read()`å†…ã®`new char[N]`ã«ã‚ˆã£ã¦å‘¼ã°ã‚Œã‚‹`operator new[]`ã«ã‚ˆã£ã¦`Foo`/`Bar`ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒæš—é»™çš„ã«æ§‹ç¯‰ã•ã‚Œã‚‹ã€‚ã“ã®å ´åˆã€`buffer[0] == FOO`ã«ã‚ˆã‚‹åˆ†å²ã«ã‚ˆã£ã¦ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã«å®šç¾©ã•ã‚ŒãŸæŒ¯ã‚‹èˆã„ã‚’ã‚‚ãŸã‚‰ã™ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯ã€`Foo`ã¨`Bar`ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦2ã¤å­˜åœ¨ã™ã‚‹ã€‚ã—ãŸãŒã£ã¦ã€ã“ã“ã§ã¯å…ˆé ­ãƒã‚¤ãƒˆã®çŠ¶æ…‹ã«å¿œã˜ã¦é©åˆ‡ãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒæ§‹ç¯‰ã•ã‚Œã‚‹ï¼ˆãã†ã™ã‚‹ã“ã¨ã§ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã«å®šç¾©ã•ã‚ŒãŸæŒ¯ã‚‹èˆã„ã‚’ã‚‚ãŸã‚‰ã™ï¼‰ãŸã‚ã€`process()`å†…ã§ã¯æœªå®šç¾©å‹•ä½œã¯å›é¿ã•ã‚Œã‚‹ã€‚

```cpp
void process(Stream *stream) {
  // ãƒã‚¤ãƒˆé…åˆ—ã®èª­ã¿å‡ºã—
  std::unique_ptr<char[]> buffer = stream->read();

  // å…ˆé ­ãƒã‚¤ãƒˆã®çŠ¶æ…‹ã«ã‚ˆã£ã¦é©åˆ‡ãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒStream::read()å†…ã§æ§‹ç¯‰ã•ã‚Œã¦ã„ã‚‹
  // ãŸã ã—ã€reinterpret_castã®ä»£ã‚ã‚Šã«std::launder()ã‚’ä½¿ç”¨ã™ã‚‹å¿…è¦ãŒã‚ã‚‹
  if (buffer[0] == FOO) {
    process_foo(std::launder<Foo>(buffer.get())); // âœ… ok
  } else {
    process_bar(std::launder<Bar>(buffer.get())); // âœ… ok
  }
}
```
* std::launder[link /reference/new/launder.md]

è¿½åŠ ã§ã€å„åˆ†å²ã«ãŠã„ã¦ã¯è¿”ã•ã‚ŒãŸ`buffer`ãƒã‚¤ãƒ³ã‚¿ï¼ˆ`char(*)[]`ï¼‰ã‹ã‚‰ã€ãã‚Œãã‚Œã®å ´åˆã§é©åˆ‡ãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆ`Foo`/`Bar`ï¼‰ã¸ã®ãƒã‚¤ãƒ³ã‚¿ã‚’[`std::launder()`](/reference/new/launder.md)ã«ã‚ˆã£ã¦å–å¾—ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚`reinterpret_cast`ã¯ãƒã‚¤ãƒ³ã‚¿ã®å¤‰æ›ã®ã¿ã‚’è¡Œã†ãŸã‚ã€ã“ã®å ´åˆã«

### å‹•çš„é…åˆ—ã®å®Ÿè£…

```cpp
// std::vectorã®æ§˜ãªå‹•çš„é…åˆ—å‹ã‚’å®Ÿè£…ã—ãŸã„
template<typename T>
struct Vec {
  char *buf = nullptr;
  char *buf_end_size = nullptr;
  char *buf_end_capacity = nullptr;

  void reserve(std::size_t n) {
    // å¾Œç¶šã®æ“ä½œã‚’é©æ ¼ã«ã™ã‚‹ãŸã‚ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æš—é»™çš„ã«æ§‹ç¯‰ã™ã‚‹
    // ã“ã“ã§ã¯ã€Tã®é…åˆ—å‹T[]ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒæš—é»™çš„ã«æ§‹ç¯‰ã•ã‚Œã‚‹ï¼ˆè¦ç´ ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯æ§‹ç¯‰ã•ã‚Œãªã„ï¼‰
    // åŒæ™‚ã«ã€char[]ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚‚æš—é»™çš„ã«æ§‹ç¯‰ã•ã‚Œã‚‹
    char *newbuf = (char*)::operator new(n * sizeof(T), std::align_val_t(alignof(T)));

    // newbufã«ã¯T[]ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒç”Ÿå­˜æœŸé–“å†…ã«ã‚ã‚‹ãŸã‚ã€ãƒã‚¤ãƒ³ã‚¿T*ã‚’ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚¿ã¨ã—ã¦ä½¿ç”¨å¯èƒ½ã¨ãªã‚‹
    // ã“ã“ã§ã€T[]ã®è¦ç´ ã®Tã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒæ§‹ç¯‰ã•ã‚Œã‚‹ï¼ˆæ˜ç¤ºçš„ï¼‰
    std::uninitialized_copy(begin(), end(), std::launder<T>(newbuf)); // #a âœ… ok

    ::operator delete(buf, std::align_val_t(alignof(T)));
    
    buf = newbuf;
    // newbufã«ã¯char[]ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒç”Ÿå­˜æœŸé–“å†…ã«ã‚ã‚‹ãŸã‚ã€newbuf(char*)ã‚’ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚¿ã¨ã—ã¦ä½¿ç”¨å¯èƒ½ã¨ãªã‚‹
    buf_end_size = newbuf + sizeof(T) * size(); // #b âœ… ok
    buf_end_capacity = newbuf + sizeof(T) * n;  // #c âœ… ok
  }

  void push_back(T t) {
    if (buf_end_size == buf_end_capacity)
      reserve(std::max<std::size_t>(size() * 2, 1));
    new (buf_end_size) T(t);

    // buf_end_sizeã®æŒ‡ã™é ˜åŸŸã«ã¯char[]ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒç”Ÿå­˜æœŸé–“å†…ã«ã‚ã‚‹ãŸã‚ã€ãƒã‚¤ãƒ³ã‚¿ã‚’ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚¿ã¨ã—ã¦ä½¿ç”¨å¯èƒ½
    buf_end_size += sizeof(T); // #d âœ… ok
  }

  T *begin() { return std::launder<T>(buf); }

  T *end() { return std::launder<T>(buf_end_size); }

  // bufåŠã³buf_end_sizeã®æŒ‡ã™é ˜åŸŸã«ã¯T[]ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒç”Ÿå­˜æœŸé–“å†…ã«ã‚ã‚‹ãŸã‚ã€ãƒã‚¤ãƒ³ã‚¿ã‚’ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚¿ã¨ã—ã¦ä½¿ç”¨å¯èƒ½
  std::size_t size() { return end() - begin(); } // #e âœ… ok
};

int main() {
  Vec<int> v;
  v.push_back(1);
  v.push_back(2);
  v.push_back(3);

  // å®Ÿè£…å†…éƒ¨ã§æš—é»™çš„ã«é…åˆ—ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒæ§‹ç¯‰ã•ã‚Œã‚‹ã“ã¨ã§UBãŒå›é¿ã•ã‚Œã‚‹
  for (int n : v) { /*...*/ } // #f âœ… ok
}
```

ã“ã®ä¾‹ã§ã¯ã€`reserve()`å†…`newbuf`åŠã³ãã‚Œã‚’ä¿å­˜ã—ã¦ã„ã‚‹`Vec::buf`ã®é ˜åŸŸã«`T[]`ï¼ˆ`T`ã®é…åˆ—å‹ï¼‰ã¨`char[]`ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒæš—é»™çš„ã«æ§‹ç¯‰ã•ã‚Œã€åŒæ™‚ã«ç”Ÿå­˜æœŸé–“å†…ã«ã‚ã‚‹ã“ã¨ã§ã€å•é¡Œï¼ˆé…åˆ—ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æŒ‡ã•ãªã„ãƒã‚¤ãƒ³ã‚¿ã®ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚¿ã¨ã—ã¦ã®ä½¿ç”¨ï¼‰ãŒè§£æ¶ˆã•ã‚Œã€ã™ã¹ã¦ã®ç®‡æ‰€ã§å®šç¾©ã•ã‚ŒãŸæŒ¯ã‚‹èˆã„ã‚’ã‚‚ãŸã‚‰ã—ã¦ã„ã‚‹ã€‚

ã“ã“ã§ã‚‚åŒæ§˜ã«ã€`newbuf`åŠã³`Vec::buf`ã‹ã‚‰éƒ½åº¦é©åˆ‡ãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¸ã®ãƒã‚¤ãƒ³ã‚¿ã‚’å¾—ã‚‹ã®ã«[`std::launder()`](/reference/new/launder.md)ã‚’ä½¿ç”¨ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚

## ã“ã®æ©Ÿèƒ½ãŒå¿…è¦ã«ãªã£ãŸèƒŒæ™¯ãƒ»çµŒç·¯
(åŸ·ç­†ä¸­)


## æ¤œè¨ã•ã‚ŒãŸã»ã‹ã®é¸æŠè‚¢
(åŸ·ç­†ä¸­)


## é–¢é€£é …ç›®

- [`start_lifetime_as()`](/reference/memory/start_lifetime_as.md.nolink)
- [`start_lifetime_as_array()`](/reference/memory/start_lifetime_as_array.md.nolink)
- [`is_implicit_lifetime`](/reference/type_traits/is_implicit_lifetime.md.nolink)

## å‚ç…§

- [P0593R6 Implicit creation of objects for low-level object manipulation](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2020/p0593r6.html)
- [CWG Issue 2325. `std::launder` and reuse of character buffers](https://cplusplus.github.io/CWG/issues/2325.html)
- [CWG Issue 2605. Implicit-lifetime aggregates](https://cplusplus.github.io/CWG/issues/2605.html)
- [P1839R5 Accessing Object Representations](https://wg21.link/p1839r5)
